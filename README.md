<!DOCTYPE html> <html lang="zh"> <head> <meta charset="utf-8"/></head> <body><h1 id="h1-gitlab-"><a name="gitlab使用说明" class="reference-link"></a><span class="header-link octicon octicon-link"></span>gitlab使用说明</h1><h2 id="h2-u6CE8u518Cu8D26u6237"><a name="注册账户" class="reference-link"></a><span class="header-link octicon octicon-link"></span>注册账户</h2><p>登陆gitlab网站注册用户，本文都以本地私有化部署的gitlab网站<a href="http://192.168.3.2">http://192.168.3.2</a> 为例来说明。<br><img src="https://github.com/yybmsrs/images/blob/master/img/users_sign_in.jpg?raw=true" alt=""><br>用户名和邮箱用公司的即可，目前不会验证邮件地址。 </p><h2 id="h2-u521Bu5EFAu9879u76EE"><a name="创建项目" class="reference-link"></a><span class="header-link octicon octicon-link"></span>创建项目</h2><p>注册后登陆，点击Create a project创建自己的项目，用法跟github都类似。<br><img src="https://github.com/yybmsrs/images/blob/master/img/dashboard_projects.jpg?raw=true" alt=""><br><img src="https://github.com/yybmsrs/images/blob/master/img/projects_new.jpg?raw=true" alt=""><br><img src="https://github.com/yybmsrs/images/blob/master/img/user_test.jpg?raw=true" alt=""> </p><h2 id="h2-u6DFBu52A0u4EE3u7801"><a name="添加代码" class="reference-link"></a><span class="header-link octicon octicon-link"></span>添加代码</h2><p>添加项目代码，这里创建main.go及main_test.go，Dockerfile用来生成镜像。gitlab默认自动Auto DevOps，项目文件改变会自动执行默认的持续集成CI，因为我们后面要用自己的CI，所以这个不用管即可。<br><img src="https://github.com/yybmsrs/images/blob/master/img/project_list_files.jpg?raw=true" alt=""><br><img src="https://github.com/yybmsrs/images/blob/master/img/master_main.go.jpg?raw=true" alt=""> </p><h2 id="h2--runner"><a name="查看runner" class="reference-link"></a><span class="header-link octicon octicon-link"></span>查看runner</h2><p>在项目左边的侧边栏里点击Settings-&gt;CI/CD,右边会看到Runners，点击Expand查看详细信息。<br><img src="https://github.com/yybmsrs/images/blob/master/img/runner.jpg?raw=true" alt=""><br><img src="https://github.com/yybmsrs/images/blob/master/img/settings_ci_cd.jpg?raw=true" alt=""><br>runner是用来执行CI/CD脚本里任务的服务，需要事先配置。可以看到runner分为三类shared runners(<strong>所有用户都可以使用</strong>), group runners（<strong>同组里所有项目可以使用</strong>）和specific runners(<strong>只有这个项目可以使用</strong>)，绿色圆圈表示正常可用的runner，蓝色方框表示该runner的tag，后续CI/CD脚本里需要指定这个tag。<br>正式项目里我们会使用事先创建的几个group runners来执行任务，如果某个项目需要自己的特殊环境runner，可以自己按照Set up a specific Runner manually里面的说明来自己注册。 </p><h2 id="h2--runner"><a name="注册runner" class="reference-link"></a><span class="header-link octicon octicon-link"></span>注册runner</h2><p>这里仅以specific Runner说明下runner的注册流程，shared runner和group runner都一样的流程。<br>首先找一台机器(需要的环境如git，docker等)，执行下面命令查看是否安装了runner，如果没有需要先按照<a href="https://docs.gitlab.com/runner/install/linux-repository.html">https://docs.gitlab.com/runner/install/linux-repository.html</a> 安装runner。</p> <pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="lang-bash"><span class="pln">ky1@ky1</span><span class="pun">-</span><span class="pln">ubuntu</span><span class="pun">:~</span><span class="pln">$ sudo gitlab</span><span class="pun">-</span><span class="pln">runner status</span></code></li><li class="L1"><code class="lang-bash"><span class="typ">Runtime</span><span class="pln"> platform arch</span><span class="pun">=</span><span class="pln">amd64 os</span><span class="pun">=</span><span class="pln">linux pid</span><span class="pun">=</span><span class="lit">27524</span><span class="pln"> revision</span><span class="pun">=</span><span class="pln">ac8e767a version</span><span class="pun">=</span><span class="lit">12.6</span><span class="pun">.</span><span class="lit">0</span></code></li><li class="L2"><code class="lang-bash"><span class="pln">gitlab</span><span class="pun">-</span><span class="pln">runner</span><span class="pun">:</span><span class="pln"> </span><span class="typ">Service</span><span class="pln"> is running</span><span class="pun">!</span></code></li><li class="L3"><code class="lang-bash"></code></li><li class="L4"><code class="lang-bash"><span class="pln">ky1@ky1</span><span class="pun">-</span><span class="pln">ubuntu</span><span class="pun">:~</span><span class="pln">$ sudo gitlab</span><span class="pun">-</span><span class="pln">runner list</span></code></li><li class="L5"><code class="lang-bash"><span class="typ">Runtime</span><span class="pln"> platform arch</span><span class="pun">=</span><span class="pln">amd64 os</span><span class="pun">=</span><span class="pln">linux pid</span><span class="pun">=</span><span class="lit">27572</span><span class="pln"> revision</span><span class="pun">=</span><span class="pln">ac8e767a version</span><span class="pun">=</span><span class="lit">12.6</span><span class="pun">.</span><span class="lit">0</span></code></li><li class="L6"><code class="lang-bash"><span class="typ">Listing</span><span class="pln"> configured runners </span><span class="typ">ConfigFile</span><span class="pun">=/</span><span class="pln">etc</span><span class="pun">/</span><span class="pln">gitlab</span><span class="pun">-</span><span class="pln">runner</span><span class="pun">/</span><span class="pln">config</span><span class="pun">.</span><span class="pln">toml</span></code></li><li class="L7"><code class="lang-bash"><span class="pln">test </span><span class="typ">Executor</span><span class="pun">=</span><span class="pln">shell </span><span class="typ">Token</span><span class="pun">=</span><span class="pln">Y6wC2hV3j57YZHMVnNxW URL</span><span class="pun">=</span><span class="pln">http</span><span class="pun">://</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">3.2</span></code></li><li class="L8"><code class="lang-bash"><span class="pln">ky1</span><span class="pun">-</span><span class="pln">ubuntu </span><span class="typ">Executor</span><span class="pun">=</span><span class="pln">shell </span><span class="typ">Token</span><span class="pun">=</span><span class="pln">m</span><span class="pun">-</span><span class="lit">3rH</span><span class="pun">-</span><span class="pln">N8V2WpMhKS84pW URL</span><span class="pun">=</span><span class="pln">http</span><span class="pun">://</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">3.2</span><span class="pun">/</span></code></li><li class="L9"><code class="lang-bash"><span class="pln">group </span><span class="typ">Executor</span><span class="pun">=</span><span class="pln">shell </span><span class="typ">Token</span><span class="pun">=</span><span class="pln">iAEjxMeDpjtuzaBYtXjc URL</span><span class="pun">=</span><span class="pln">http</span><span class="pun">://</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">3.2</span><span class="pun">/</span></code></li><li class="L0"><code class="lang-bash"><span class="pln">share </span><span class="typ">Executor</span><span class="pun">=</span><span class="pln">shell </span><span class="typ">Token</span><span class="pun">=</span><span class="pln">RJDH8uc9f</span><span class="pun">-</span><span class="lit">6je2HijCYC</span><span class="pln"> URL</span><span class="pun">=</span><span class="pln">http</span><span class="pun">://</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">3.2</span><span class="pun">/</span></code></li></ol></pre> <p>然后按照<a href="https://docs.gitlab.com/runner/register/index.html">https://docs.gitlab.com/runner/register/index.html</a> 注册runner：</p> <pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="lang-bash"><span class="pln">ky1@ky1</span><span class="pun">-</span><span class="pln">ubuntu</span><span class="pun">:~</span><span class="pln">$ sudo gitlab</span><span class="pun">-</span><span class="pln">runner register</span></code></li><li class="L1"><code class="lang-bash"><span class="typ">Runtime</span><span class="pln"> platform arch</span><span class="pun">=</span><span class="pln">amd64 os</span><span class="pun">=</span><span class="pln">linux pid</span><span class="pun">=</span><span class="lit">5722</span><span class="pln"> revision</span><span class="pun">=</span><span class="pln">ac8e767a version</span><span class="pun">=</span><span class="lit">12.6</span><span class="pun">.</span><span class="lit">0</span></code></li><li class="L2"><code class="lang-bash"><span class="typ">Running</span><span class="pln"> </span><span class="kwd">in</span><span class="pln"> system</span><span class="pun">-</span><span class="pln">mode</span><span class="pun">.</span></code></li><li class="L3"><code class="lang-bash"></code></li><li class="L4"><code class="lang-bash"><span class="typ">Please</span><span class="pln"> enter the gitlab</span><span class="pun">-</span><span class="pln">ci coordinator URL </span><span class="pun">(</span><span class="pln">e</span><span class="pun">.</span><span class="pln">g</span><span class="pun">.</span><span class="pln"> https</span><span class="pun">://</span><span class="pln">gitlab</span><span class="pun">.</span><span class="pln">com</span><span class="pun">/):</span></code></li><li class="L5"><code class="lang-bash"><span class="pln">http</span><span class="pun">://</span><span class="lit">192.168</span><span class="pun">.</span><span class="lit">3.2</span><span class="pun">/</span></code></li><li class="L6"><code class="lang-bash"><span class="typ">Please</span><span class="pln"> enter the gitlab</span><span class="pun">-</span><span class="pln">ci token </span><span class="kwd">for</span><span class="pln"> this runner</span><span class="pun">:</span></code></li><li class="L7"><code class="lang-bash"><span class="pln">esMTLzq86Nh7K7eUStNN</span></code></li><li class="L8"><code class="lang-bash"><span class="typ">Please</span><span class="pln"> enter the gitlab</span><span class="pun">-</span><span class="pln">ci description </span><span class="kwd">for</span><span class="pln"> this runner</span><span class="pun">:</span></code></li><li class="L9"><code class="lang-bash"><span class="pun">[</span><span class="pln">ky1</span><span class="pun">-</span><span class="pln">ubuntu</span><span class="pun">]:</span><span class="pln"> </span><span class="kwd">for</span><span class="pln"> test</span></code></li><li class="L0"><code class="lang-bash"><span class="typ">Please</span><span class="pln"> enter the gitlab</span><span class="pun">-</span><span class="pln">ci tags </span><span class="kwd">for</span><span class="pln"> this runner </span><span class="pun">(</span><span class="pln">comma separated</span><span class="pun">):</span></code></li><li class="L1"><code class="lang-bash"><span class="pln">testtest</span></code></li><li class="L2"><code class="lang-bash"><span class="typ">Registering</span><span class="pln"> runner</span><span class="pun">...</span><span class="pln"> succeeded runner</span><span class="pun">=</span><span class="pln">esMTLzq8</span></code></li><li class="L3"><code class="lang-bash"><span class="typ">Please</span><span class="pln"> enter the executor</span><span class="pun">:</span><span class="pln"> custom</span><span class="pun">,</span><span class="pln"> docker</span><span class="pun">-</span><span class="pln">ssh</span><span class="pun">,</span><span class="pln"> parallels</span><span class="pun">,</span><span class="pln"> kubernetes</span><span class="pun">,</span><span class="pln"> docker</span><span class="pun">,</span><span class="pln"> shell</span><span class="pun">,</span><span class="pln"> ssh</span><span class="pun">,</span><span class="pln"> virtualbox</span><span class="pun">,</span><span class="pln"> docker</span><span class="pun">+</span><span class="pln">machine</span><span class="pun">,</span><span class="pln"> docker</span><span class="pun">-</span><span class="pln">ssh</span><span class="pun">+</span><span class="pln">machine</span><span class="pun">:</span></code></li><li class="L4"><code class="lang-bash"><span class="pln">shell</span></code></li><li class="L5"><code class="lang-bash"><span class="typ">Runner</span><span class="pln"> registered successfully</span><span class="pun">.</span><span class="pln"> </span><span class="typ">Feel</span><span class="pln"> free to start it</span><span class="pun">,</span><span class="pln"> but </span><span class="kwd">if</span><span class="pln"> it</span><span class="str">'s running already the config should be automatically reloaded!</span></code></li><li class="L6"><code class="lang-bash"></code></li><li class="L7"><code class="lang-bash"><span class="str">ky1@ky1-ubuntu:~$ sudo gitlab-runner list</span></code></li><li class="L8"><code class="lang-bash"><span class="str">Runtime platform arch=amd64 os=linux pid=5914 revision=ac8e767a version=12.6.0</span></code></li><li class="L9"><code class="lang-bash"><span class="str">Listing configured runners ConfigFile=/etc/gitlab-runner/config.toml</span></code></li><li class="L0"><code class="lang-bash"><span class="str">test Executor=shell Token=Y6wC2hV3j57YZHMVnNxW URL=http://192.168.3.2</span></code></li><li class="L1"><code class="lang-bash"><span class="str">ky1-ubuntu Executor=shell Token=m-3rH-N8V2WpMhKS84pW URL=http://192.168.3.2/</span></code></li><li class="L2"><code class="lang-bash"><span class="str">group Executor=shell Token=iAEjxMeDpjtuzaBYtXjc URL=http://192.168.3.2/</span></code></li><li class="L3"><code class="lang-bash"><span class="str">share Executor=shell Token=RJDH8uc9f-6je2HijCYC URL=http://192.168.3.2/</span></code></li><li class="L4"><code class="lang-bash"><span class="str">for test Executor=shell Token=zZKjsKv1JzjdGnnSFTdP URL=http://192.168.3.2/</span></code></li></ol></pre> <p>在页面查看刚注册的tag为testtest的runner：<br><img src="https://github.com/yybmsrs/images/blob/master/img/test_runner.jpg?raw=true" alt=""> </p><h2 id="h2-ci-"><a name="CI脚本" class="reference-link"></a><span class="header-link octicon octicon-link"></span>CI脚本</h2><p>在项目的根目录下添加配置文件.gitlab-ci.yml就可以实现CI，其内容如下：</p> <pre class="prettyprint linenums prettyprinted" style=""><ol class="linenums"><li class="L0"><code class="lang-yaml"><span class="pln">stages</span><span class="pun">:</span></code></li><li class="L1"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> test</span></code></li><li class="L2"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> deploy</span></code></li><li class="L3"><code class="lang-yaml"></code></li><li class="L4"><code class="lang-yaml"><span class="pln">docker</span><span class="pun">-</span><span class="pln">deploy</span><span class="pun">:</span></code></li><li class="L5"><code class="lang-yaml"><span class="pln"> stage</span><span class="pun">:</span><span class="pln"> deploy</span></code></li><li class="L6"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 执行Job内容</span></code></li><li class="L7"><code class="lang-yaml"><span class="pln"> script</span><span class="pun">:</span></code></li><li class="L8"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 通过Dockerfile生成镜像</span></code></li><li class="L9"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> docker build </span><span class="pun">-</span><span class="pln">t test </span><span class="pun">.</span></code></li><li class="L0"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 删除已经在运行的容器</span></code></li><li class="L1"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> </span><span class="kwd">if</span><span class="pln"> </span><span class="pun">[</span><span class="pln"> $</span><span class="pun">(</span><span class="pln">docker ps </span><span class="pun">-</span><span class="pln">aq </span><span class="pun">--</span><span class="pln">filter name</span><span class="pun">=</span><span class="pln">test</span><span class="pun">)</span><span class="pln"> </span><span class="pun">];</span><span class="pln"> </span><span class="kwd">then</span><span class="pln"> docker rm </span><span class="pun">-</span><span class="pln">f test</span><span class="pun">;</span><span class="kwd">fi</span></code></li><li class="L2"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 通过镜像启动容器</span></code></li><li class="L3"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> docker run </span><span class="pun">-</span><span class="pln">d </span><span class="pun">--</span><span class="pln">name test test</span></code></li><li class="L4"><code class="lang-yaml"><span class="pln"> tags</span><span class="pun">:</span></code></li><li class="L5"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 执行Job的runner</span></code></li><li class="L6"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> testtest</span></code></li><li class="L7"><code class="lang-yaml"><span class="pln"> only</span><span class="pun">:</span></code></li><li class="L8"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 只有在master分支才会执行</span></code></li><li class="L9"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> master</span></code></li><li class="L0"><code class="lang-yaml"></code></li><li class="L1"><code class="lang-yaml"><span class="pln">go</span><span class="pun">-</span><span class="pln">test</span><span class="pun">:</span></code></li><li class="L2"><code class="lang-yaml"><span class="pln"> stage</span><span class="pun">:</span><span class="pln"> test</span></code></li><li class="L3"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 执行Job内容</span></code></li><li class="L4"><code class="lang-yaml"><span class="pln"> script</span><span class="pun">:</span></code></li><li class="L5"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> go test </span><span class="pun">./...</span></code></li><li class="L6"><code class="lang-yaml"><span class="pln"> tags</span><span class="pun">:</span></code></li><li class="L7"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 执行Job的runner</span></code></li><li class="L8"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> testtest</span></code></li><li class="L9"><code class="lang-yaml"><span class="pln"> only</span><span class="pun">:</span></code></li><li class="L0"><code class="lang-yaml"><span class="pln"> </span><span class="com"># 只有在master分支才会执行</span></code></li><li class="L1"><code class="lang-yaml"><span class="pln"> </span><span class="pun">-</span><span class="pln"> master</span></code></li></ol></pre> <p>可以看到这个项目的执行分为两步test和deploy，每一步都有具体要执行的script以及执行的runner的tag和分支，每个stage可以有多个job，并行执行多个job。具体用法可以参考<a href="https://docs.gitlab.com/ee/ci/quick_start/README.html#creating-a-gitlab-ciyml-file">https://docs.gitlab.com/ee/ci/quick_start/README.html#creating-a-gitlab-ciyml-file</a></p> <h2 id="h2--ci"><a name="执行CI" class="reference-link"></a><span class="header-link octicon octicon-link"></span>执行CI</h2><p>根据.gitlab-ci.yml脚本内容，如果master分支有新的提交，则CI任务就会自动执行。<br><img src="https://github.com/yybmsrs/images/blob/master/img/pennding.jpg?raw=true" alt=""><br>项目上面会有个执行状态，如上图所示，点击进去或者从侧边栏中CI/CD-&gt;Pipelines进去可以看到所有CI历史任务列表，每个任务执行结果也都会显示，passed表示执行成功。如果想再次执行一遍可以点击绿色的Run Pipeline而不用修改内容。这里的Ci Lint按钮可以验证.gitlab-ci.yml语法是否正确。<br><img src="https://github.com/yybmsrs/images/blob/master/img/history.jpg?raw=true" alt=""><br>点击pipeline栏的数字id则会看到具体每个job的执行状态：<br><img src="https://github.com/yybmsrs/images/blob/master/img/pipelines_builds.jpg?raw=true" alt=""><br>点击jobid进去可以看到具体的执行日志，如果报错也能看到具体原因：<br><img src="https://github.com/yybmsrs/images/blob/master/img/jobs_50.jpg?raw=true" alt=""> </p><h2 id="h2-u5176u5B83"><a name="其它" class="reference-link"></a><span class="header-link octicon octicon-link"></span>其它</h2><p>上面显示的只是gitlab-ci的基本用法，至于高级用法如上传编译结果，查看历史统计，定时执行，设置环境变量等可以参考官方文档<a href="https://docs.gitlab.com/ee/ci/introduction/">https://docs.gitlab.com/ee/ci/introduction/</a> ，另外还可以参考这个go语言的具体实践<a href="https://about.gitlab.com/blog/2017/11/27/go-tools-and-gitlab-how-to-do-continuous-integration-like-a-boss/">https://about.gitlab.com/blog/2017/11/27/go-tools-and-gitlab-how-to-do-continuous-integration-like-a-boss/</a></p> </body> </html>
